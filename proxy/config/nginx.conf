worker_processes auto;
error_log /dev/stdout;
pid /run/nginx.pid;

events {
    worker_connections 768;
    multi_accept on;
}

http {
    map $http_origin $cors_origin {
        default "";
        "https://transendence.com" $http_origin;
        "https://auth.transendence.com" $http_origin;
        "http://unsafeauth.transendence.com" $http_origin;
        "https://tournament.transendence.com" $http_origin;
        "https://game.transendence.com" $http_origin;
        "https://cadvisor.transendence.com" $http_origin;
        "https://prometheus.transendence.com" $http_origin;
        "https://grafana.transendence.com" $http_origin;
        "https://alertmanager.transendence.com" $http_origin;
        "https://elasticsearch.transendence.com" $http_origin;
        "https://kibana.transendence.com" $http_origin;
    }

    log_format detailed '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '$request_time $upstream_response_time $upstream_addr '
                        '$request_length $bytes_sent $msec $connection $connection_requests';
    access_log /dev/stdout detailed;

    include /etc/nginx/mime.types;
    
    server {
        listen 443 ssl default_server;
        ssl_certificate  	/etc/ssl/certs/ssl.crt;
        ssl_certificate_key	/etc/ssl/certs/ssl.key;
        #listen 80; 
        return 404;
    }

    server {
        include server_common.conf; 
        server_name prometheus.transendence.com;

        auth_basic "Prometheus";
        auth_basic_user_file /etc/auth/.htpasswd;

        location / {
            proxy_pass http://127.0.0.1:9090;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }

    server {
        include server_common.conf; 
        server_name alertmanager.transendence.com;

        auth_basic "Alert Manager";
        auth_basic_user_file /etc/auth/.htpasswd;

        location / {
            proxy_pass http://127.0.0.1:9093;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }

    server {
        include server_common.conf; 
        server_name cadvisor.transendence.com;

        auth_basic "CAdvisor";
        auth_basic_user_file /etc/auth/.htpasswd;

        location / {
            proxy_pass http://127.0.0.1:8080;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }

    server {
        include server_common.conf; 
        server_name grafana.transendence.com;

        location / {
            proxy_pass http://127.0.0.1:3000;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }

    server {
        include server_common.conf; 
        server_name tournament.transendence.com;

        location / {
            proxy_pass http://127.0.0.1:8083;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }

        location /docs {
            proxy_pass http://127.0.0.1:8083/docs;
        }
    }

    server {
        include server_common.conf; 
        server_name kibana.transendence.com;

        location / {
            proxy_pass http://127.0.0.1:5601;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }

    server {
       listen 80;
       server_name unsafeauth.transendence.com;
       location / {
         proxy_pass http://127.0.0.1:8081;
         include /etc/nginx/transendence-config/proxy_common.conf;
       }
    }

    server {
        include server_common.conf; 
        server_name auth.transendence.com;
        #ssl_certificate     /etc/ssl/certs/ssl.crt;
        #ssl_certificate_key /etc/ssl/certs/ssl.key;

        location / {
            proxy_pass http://127.0.0.1:8081;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }

        location /docs {
            proxy_pass http://127.0.0.1:8081/docs;
        }

    }

    server {
        include server_common.conf;
        server_name transendence.com;
        #ssl_certificate     /etc/ssl/certs/ssl.crt;
        #ssl_certificate_key /etc/ssl/certs/ssl.key;
        gzip on;
        gzip_types *;
        gzip_static  on;
        gzip_comp_level 9;

        root /var/www/html/;
        index index.html;

        location ~* \.(js|css|png|jpg|jpeg|svg|webp)$ {
            expires 31536000s;
		    try_files $uri $uri =404;
        }

        location ~* \.(html)$ {
            add_header Cache-Control "no-cache";
            try_files $uri $uri =404;
        }

        location / {
            try_files $uri $uri/ /index.html;
        }
    }

    server {
        include server_common.conf; 
        server_name game.transendence.com;

        #ssl_certificate     /etc/ssl/certs/ssl.crt;
        #ssl_certificate_key /etc/ssl/certs/ssl.key;

    	location /socket.io/ {
            proxy_pass http://127.0.0.1:3001;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Origin http://transendence.com;
            proxy_read_timeout 86400;
            proxy_buffering off;
            proxy_request_buffering off;
        }

        location / {
            proxy_pass http://127.0.0.1:3001;
            include    /etc/nginx/transendence-config/proxy_common.conf;
        }
    }
}
